// ==UserScript==
// @name         UNU Task Opener (Cmd+K / Cmd+U / Cmd+M / Buttons)
// @namespace    http://tampermonkey.net/
// @version      2.13
// @description  Cmd+K ‚Äî –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è —Å —Ç–∞–π–º–µ—Ä–æ–º, Cmd+U ‚Äî —Å–æ—Ü—Å–µ—Ç–∏ 60 —Å–µ–∫, Cmd+M ‚Äî –ø–æ–º–∏–Ω—É—Ç–Ω—ã–µ, –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ —á–∞—Å–æ–≤—ã–µ —Å –≤–≤–æ–¥–æ–º —á–∏—Å–ª–∞ —á–∞—Å–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª)
// @author       You
// @match        https://unu.im/tasks/works*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    window.UNU_STATE = window.UNU_STATE || {
        openedLinks: new Set(),
        openingStopped: true,
        currentlyOpening: false,
        socialOnly: false,
        minuteOnly: false,
        hourlyOnly: false,
        targetHours: [], // –∏–∑–º–µ–Ω–µ–Ω–æ —Å –æ–¥–Ω–æ–≥–æ —á–∏—Å–ª–∞ –Ω–∞ –º–∞—Å—Å–∏–≤
        timer: null,
        remainingTime: 0,
        startTime: 0,
        lastOpenedHourlyCounts: {}, // –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ –∫–∞–∂–¥–æ–º—É —á–∞—Å—É
        lastOpenedHourlyHours: [], // –∫–∞–∫–∏–µ —á–∞—Å—ã –±—ã–ª–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        prevOpenedHourlyCounts: {}, // –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ (–∫–æ–ª-–≤–∞)
        prevOpenedHourlyHours: []  // –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ (—á–∞—Å—ã)
    };

    const socialKeywords = [
        "whatsapp", "facebook", "likee", "–Ω—Ñ–±–∏", "–ø–æ—Å–ª—É—à–∞—Ç—å", "–±–æ—Ç–∞",
        "–æ–∑–æ–Ω", "ozon", "wb", "wildbiries", "–≤–±", "–Ω–∞–π—Ç–∏ –∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
        "twitter", "–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫!", "watsaap", "–≤–∞—Ç—Å–∞–ø", "whatsap", "whatsapp"
    ];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π div –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö —á–∞—Å–æ–≤
    let lastOpenedHoursDiv = null;
    function updateLastOpenedHours(hoursArr, hourlyCounts, isNew = false) {
        if (lastOpenedHoursDiv) {
            if (Array.isArray(hoursArr) && hoursArr.length > 0) {
                let text = '';
                let total = 0;
                if (isNew) {
                    text += `–û—Ç–∫—Ä—ã—Ç–æ –Ω–æ–≤–æ–µ: ${hoursArr.map(h => `${h}-${hourlyCounts[h] || 0}`).join(' ')}`;
                    total += hoursArr.reduce((sum, h) => sum + (hourlyCounts[h] || 0), 0);
                    // –ø–æ–∫–∞–∑–∞—Ç—å "–†–∞–Ω–µ–µ" –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (window.UNU_STATE.prevOpenedHourlyHours && window.UNU_STATE.prevOpenedHourlyHours.length > 0) {
                        text += `\n–†–∞–Ω–µ–µ: ${window.UNU_STATE.prevOpenedHourlyHours.map(h => `${h}-${window.UNU_STATE.prevOpenedHourlyCounts[h] || 0}`).join(' ')}`;
                        total += window.UNU_STATE.prevOpenedHourlyHours.reduce((sum, h) => sum + (window.UNU_STATE.prevOpenedHourlyCounts[h] || 0), 0);
                    }
                    text += ` –æ–±—â–µ–µ: ${total}`;
                } else {
                    text += `–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ: ${hoursArr.join(' ')}`;
                    if (hourlyCounts && typeof hourlyCounts === 'object' && Object.keys(hourlyCounts).length > 0) {
                        text += ' ' + hoursArr.map(h => `${h}-${hourlyCounts[h] || 0}`).join(' ');
                        total += hoursArr.reduce((sum, h) => sum + (hourlyCounts[h] || 0), 0);
                    }
                    text += ` –æ–±—â–µ–µ: ${total}`;
                }
                lastOpenedHoursDiv.textContent = text;
            } else {
                lastOpenedHoursDiv.textContent = "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ: -";
            }
        }
    }

    if (window.location.href.includes("/tasks/works")) {
        setupUI();
        highlightJobs();
        applyTheme(localStorage.getItem("theme") || "light");
        observeDOM();

        // === –°—É–º–º–∞ –≤—Å–µ—Ö .sum –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ===
        function sumAllJobSums() {
            const sumEls = document.querySelectorAll('.job-table__row .sum');
            let total = 0;
            sumEls.forEach(el => {
                const val = parseFloat((el.textContent || '').replace(/[^\d.,]/g, '').replace(',', '.'));
                if (!isNaN(val)) total += val;
            });
            console.log('[UNU] –°—É–º–º–∞ –≤—Å–µ—Ö –≤—ã–ø–ª–∞—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:', total.toFixed(2));
            return total;
        }

        // UI —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —Å—É–º–º—ã
        const sumCounter = document.createElement('div');
        sumCounter.style.gridColumn = '1 / span 2';
        sumCounter.style.textAlign = 'center';
        sumCounter.style.fontWeight = 'bold';
        sumCounter.style.background = '#e6fff3';
        sumCounter.style.marginTop = '-2px';
        sumCounter.style.marginBottom = '-2px';
        sumCounter.style.fontSize = '15px';
        sumCounter.style.color = '#009688';
        sumCounter.textContent = '–°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç: ...';
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ counterDiff
        const ui = document.getElementById('unu-task-opener-ui');
        if (ui) {
            const idx = Array.from(ui.children).indexOf(ui.querySelector('div[style*="b800ff"]'));
            if (idx >= 0 && idx < ui.children.length - 1) {
                ui.insertBefore(sumCounter, ui.children[idx + 1]);
            } else {
                ui.appendChild(sumCounter);
            }
        }

        // –û–±–Ω–æ–≤–ª—è—Ç—å —Å—É–º–º—É –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(() => {
            const total = sumAllJobSums();
            sumCounter.textContent = '–°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç: ' + total.toFixed(2) + ' —Ä—É–±';
        }, 1000);

        document.addEventListener("keydown", (event) => {
            if (event.metaKey && event.key.toLowerCase() === "k") {
                event.preventDefault();
                const time = prompt("–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö:", "10");
                if (time && !isNaN(time) && parseInt(time) > 0) {
                    startOpening(false, parseInt(time));
                }
            }
            if (event.metaKey && event.key.toLowerCase() === "u") {
                event.preventDefault();
                const time = prompt("–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö:", "10");
                if (time && !isNaN(time) && parseInt(time) > 0) {
                    startOpening(true, parseInt(time));
                }
            }
            if (event.metaKey && event.key.toLowerCase() === "m") {
                event.preventDefault();
                const input = prompt("–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1 2 3):", "1");
                if (input) {
                    const hours = input
                        .split(/\s+/)
                        .map(x => parseInt(x.trim()))
                        .filter(x => !isNaN(x));
                    updateLastOpenedHours(hours, undefined); // –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ hours –ø—É—Å—Ç–æ–π
                    if (hours.length > 0) {
                        startOpening(false, null, false, true, hours);
                    } else {
                        alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥ —á–∞—Å–æ–≤.");
                    }
                } else {
                    updateLastOpenedHours([], undefined); // –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏ prompt
                }
            }
        });
    }

    function setupUI() {
        const container = document.createElement("div");
        container.style.position = "fixed";
        container.style.top = "120px";
        container.style.left = "50%";
        container.style.transform = "translateX(-50%)";
        container.style.zIndex = "1000";
        container.style.display = "grid";
        container.style.gridTemplateColumns = "repeat(2, 1fr)";
        container.style.gap = "10px";
        container.style.width = "290px";
        container.style.background = "#fff";
        container.style.padding = "10px 10px 6px 10px";
        container.style.borderRadius = "10px";
        container.style.boxShadow = "none";
        container.style.border = "1.5px solid #e0e0e0";
        container.id = "unu-task-opener-ui";

        function createButton(text, color, onClick, icon) {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.style.padding = "8px 0";
            btn.style.background = `linear-gradient(90deg, ${color} 80%, #fff0 100%)`;
            btn.style.color = "#fff";
            btn.style.border = "none";
            btn.style.borderRadius = "7px";
            btn.style.cursor = "pointer";
            btn.style.fontSize = "15px";
            btn.style.fontWeight = "600";
            btn.style.boxShadow = "none";
            btn.style.transition = "background 0.2s";
            btn.style.width = "100%";
            btn.style.display = "flex";
            btn.style.alignItems = "center";
            btn.style.justifyContent = "center";
            btn.style.gap = "8px";
            btn.onmouseover = () => btn.style.background = `linear-gradient(90deg, ${color} 100%, #fff0 100%)`;
            btn.onmouseout = () => btn.style.background = `linear-gradient(90deg, ${color} 80%, #fff0 100%)`;
            if (icon) {
                const iconSpan = document.createElement("span");
                iconSpan.innerHTML = icon;
                btn.prepend(iconSpan);
            }
            btn.addEventListener("click", onClick);
            return btn;
        }

        function createCounter(text, color) {
            const el = document.createElement("div");
            el.style.fontSize = "13px";
            el.style.color = color || "#888";
            el.style.alignSelf = "center";
            el.style.background = "#f7f7fa";
            el.style.borderRadius = "6px";
            el.style.padding = "2px 8px";
            el.style.justifySelf = "end";
            el.style.marginLeft = "6px";
            el.textContent = text;
            return el;
        }

        const btnAll = createButton("–í—Å–µ –∑–∞–¥–∞–Ω–∏—è", "#ff4b4b", () => {
            const time = prompt("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (—Å–µ–∫):", "10");
            if (time && !isNaN(time) && parseInt(time) > 0) {
                startOpening(false, parseInt(time));
            }
        }, 'üóÇÔ∏è');

        const btnSocial = createButton("–°–æ—Ü—Å–µ—Ç–∏", "#4b83ff", () => {
            const time = prompt("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (—Å–µ–∫):", "10");
            if (time && !isNaN(time) && parseInt(time) > 0) {
                startOpening(true, parseInt(time));
            }
        }, 'üåê');

        const btnMinute = createButton("–ú–∏–Ω—É—Ç–Ω—ã–µ", "#4bff4b", () => {
            startOpening(false, null, true);
        }, '‚è±Ô∏è');

        const btnHourly = createButton("–ß–∞—Å–æ–≤—ã–µ", "#ff8c00", () => {
            const input = prompt("–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1 2 3):", "1");
            if (input) {
                const hours = input
                    .split(/\s+/)
                    .map(x => parseInt(x.trim()))
                    .filter(x => !isNaN(x));
                updateLastOpenedHours(hours, undefined); // –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ hours –ø—É—Å—Ç–æ–π
                if (hours.length > 0) {
                    startOpening(false, null, false, true, hours);
                } else {
                    alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥ —á–∞—Å–æ–≤.");
                }
            } else {
                updateLastOpenedHours([], undefined); // –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏ prompt
            }
        }, '‚è∞');

        // === –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –∏ –º–æ–¥–∞–ª–∫–∞ ===
        const btnTimeCalc = createButton("–î–æ –≤—Ä–µ–º–µ–Ω–∏", "#8c4bff", () => {
            showTimeCalcModal();
        }, 'üïí');

        // === –ö–Ω–æ–ø–∫–∞ –∏ –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ –ø–æ —á–∞—Å–∞–º ===
        const btnHourCount = createButton("–ü–æ–¥—Å—á—ë—Ç –ø–æ —á–∞—Å–∞–º", "#00bcd4", () => {
            showHourCountModal();
        }, 'üßÆ');

        // === –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –∏ –º–æ–¥–∞–ª–∫–∞ –¥–ª—è "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ —á–∞—Å–∞–º" ===
        const btnVerificationCount = createButton("–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ —á–∞—Å–∞–º", "#ffb300", () => {
            showVerificationCountModal();
        }, 'üïµÔ∏è‚Äç‚ôÇÔ∏è');

        const counterAll = createCounter("–í—Å–µ–≥–æ: 0", "#ff4b4b");
        const counterSocial = createCounter("–°–æ—Ü—Å–µ—Ç–∏: 0", "#4b83ff");
        const counterMinute = createCounter("–ú–∏–Ω—É—Ç–Ω—ã–µ: 0", "#4bff4b");
        const counterHourly = createCounter("–ß–∞—Å–æ–≤—ã–µ: 0", "#ff8c00");

        // –ù–æ–≤—ã–π —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–Ω–∏—Ü—ã
        const counterDiff = createCounter("–í —Ä–∞–±–æ—Ç–µ - –í—Å–µ–≥–æ: ...", "#b800ff");
        counterDiff.style.gridColumn = "1 / span 2";
        counterDiff.style.textAlign = "center";
        counterDiff.style.fontWeight = "bold";
        counterDiff.style.background = "#f3e6ff";
        counterDiff.style.marginTop = "-2px";
        counterDiff.style.marginBottom = "-2px";

        lastOpenedHoursDiv = document.createElement("div");
        lastOpenedHoursDiv.style.gridColumn = "1 / span 2";
        lastOpenedHoursDiv.style.fontSize = "14px";
        lastOpenedHoursDiv.style.marginTop = "7px";
        lastOpenedHoursDiv.style.marginBottom = "-2px";
        lastOpenedHoursDiv.style.fontWeight = "bold";
        lastOpenedHoursDiv.style.letterSpacing = "0.5px";
        lastOpenedHoursDiv.style.background = "#f3f3f8";
        lastOpenedHoursDiv.style.borderRadius = "6px";
        lastOpenedHoursDiv.style.padding = "5px 0 3px 0";
        lastOpenedHoursDiv.textContent = "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ: -";

        container.appendChild(btnAll);
        container.appendChild(counterAll);
        container.appendChild(btnSocial);
        container.appendChild(counterSocial);
        container.appendChild(btnMinute);
        container.appendChild(counterMinute);
        container.appendChild(btnHourly);
        container.appendChild(counterHourly);
        container.appendChild(btnTimeCalc); // –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É
        container.appendChild(btnHourCount); // –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Å—á—ë—Ç–∞ –ø–æ —á–∞—Å–∞–º
        container.appendChild(btnVerificationCount); // –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ —á–∞—Å–∞–º
        container.appendChild(counterDiff); // –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å—á–µ—Ç—á–∏–∫
        container.appendChild(lastOpenedHoursDiv);

        document.body.appendChild(container);

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∏—Å–ª–∞ "–ó–∞–¥–∞–Ω–∏–π –≤ —Ä–∞–±–æ—Ç–µ" —Å –ø—Ä–æ—Ñ–∏–ª—è ---
        let tasksInProgress = null;
        async function fetchTasksInProgress() {
            try {
                const resp = await fetch('https://unu.im/users/2089641', { credentials: 'include' });
                const html = await resp.text();
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:
                const match = html.match(/<tr><td>–ó–∞–¥–∞–Ω–∏–π –≤ —Ä–∞–±–æ—Ç–µ:<\/td><td>(\d+)<\/td><\/tr>/);
                if (match) {
                    tasksInProgress = parseInt(match[1], 10);
                }
            } catch (e) {
                tasksInProgress = null;
            }
        }
        fetchTasksInProgress();
        // –û–±–Ω–æ–≤–ª—è—Ç—å —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç
        setInterval(fetchTasksInProgress, 5 * 60 * 1000);

        setInterval(() => {
            const jobs = document.querySelectorAll('.job-name');
            const allCount = jobs.length;

            const socialCountVal = Array.from(jobs).filter(el => {
                const text = el.textContent.toLowerCase();
                return socialKeywords.some(kw => text.includes(kw));
            }).length;

            const minuteCountVal = Array.from(document.querySelectorAll('.job-table__row')).filter(row => {
                const status = row.querySelector('.job__status-work')?.textContent || '';
                return /\d+\s*–º–∏–Ω/.test(status);
            }).length;

            const hourlyCountVal = Array.from(document.querySelectorAll('.job-table__row')).filter(row => {
                const status = row.querySelector('.job__status-work')?.textContent || '';
                return /\d+\s*—á–∞—Å/.test(status);
            }).length;

            counterAll.textContent = `–í—Å–µ–≥–æ: ${allCount}`;
            counterSocial.textContent = `–°–æ—Ü—Å–µ—Ç–∏: ${socialCountVal}`;
            counterMinute.textContent = `–ú–∏–Ω—É—Ç–Ω—ã–µ: ${minuteCountVal}`;
            counterHourly.textContent = `–ß–∞—Å–æ–≤—ã–µ: ${hourlyCountVal}`;
            // --- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É ---
            if (tasksInProgress !== null) {
                const diff = tasksInProgress - allCount;
                counterDiff.textContent = `–í —Ä–∞–±–æ—Ç–µ - –í—Å–µ–≥–æ: ${tasksInProgress} - ${allCount} = ${diff}`;
                counterDiff.style.color = diff > 0 ? '#b800ff' : (diff < 0 ? '#ff0000' : '#00b800');
            } else {
                counterDiff.textContent = '–í —Ä–∞–±–æ—Ç–µ - –í—Å–µ–≥–æ: ...';
                counterDiff.style.color = '#b800ff';
            }
        }, 1000);
    }

    function startOpening(socialOnly, time, minuteOnly = false, hourlyOnly = false, targetHours = []) {
        if (window.UNU_STATE.currentlyOpening) {
            stopOpening();
            return;
        }

        // --- –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π ---
        if (hourlyOnly && window.UNU_STATE.lastOpenedHourlyHours && window.UNU_STATE.lastOpenedHourlyHours.length > 0) {
            // –µ—Å–ª–∏ –Ω–æ–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
            const intersection = targetHours.filter(h => window.UNU_STATE.lastOpenedHourlyHours.includes(h));
            if (intersection.length === 0) {
                // –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–µ–∫—É—â–µ–µ –≤ prev
                window.UNU_STATE.prevOpenedHourlyCounts = {...window.UNU_STATE.lastOpenedHourlyCounts};
                window.UNU_STATE.prevOpenedHourlyHours = [...window.UNU_STATE.lastOpenedHourlyHours];
                // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ
                window.UNU_STATE.lastOpenedHourlyCounts = {};
                window.UNU_STATE.lastOpenedHourlyHours = [];
            }
        }
        // --- –∫–æ–Ω–µ—Ü –ª–æ–≥–∏–∫–∏ ---

        window.UNU_STATE.openingStopped = false;
        window.UNU_STATE.currentlyOpening = true;
        window.UNU_STATE.socialOnly = socialOnly;
        window.UNU_STATE.minuteOnly = minuteOnly;
        window.UNU_STATE.hourlyOnly = hourlyOnly;
        window.UNU_STATE.targetHours = targetHours;
        window.UNU_STATE.remainingTime = time || 0;
        window.UNU_STATE.startTime = Date.now();
        window.UNU_STATE.openedLinks.clear();
        if (hourlyOnly) {
            window.UNU_STATE.lastOpenedHourlyCounts = {}; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            window.UNU_STATE.lastOpenedHourlyHours = targetHours;
        }

        processBatch();
    }

    function stopOpening() {
        window.UNU_STATE.openingStopped = true;
        window.UNU_STATE.currentlyOpening = false;
        clearTimeout(window.UNU_STATE.timer);
    }

    function processBatch() {
        if (window.UNU_STATE.openingStopped) return;

        const elapsed = (Date.now() - window.UNU_STATE.startTime) / 1000;
        if (!window.UNU_STATE.minuteOnly && !window.UNU_STATE.hourlyOnly &&
            window.UNU_STATE.remainingTime > 0 && elapsed > window.UNU_STATE.remainingTime) {
            stopOpening();
            return;
        }

        let candidateJobs = Array.from(document.querySelectorAll('.job-table__row'));

        if (window.UNU_STATE.socialOnly) {
            candidateJobs = candidateJobs.filter(row => {
                const jobName = row.querySelector('.job-name')?.textContent.toLowerCase() || "";
                return socialKeywords.some(kw => jobName.includes(kw));
            });
        } else if (window.UNU_STATE.minuteOnly) {
            candidateJobs = candidateJobs
                .filter(row => /\d+\s*–º–∏–Ω/.test(row.querySelector('.job__status-work')?.textContent || ""))
                .sort((a, b) => {
                    const getMin = row => parseInt((row.querySelector('.job__status-work')?.textContent || "").match(/(\d+)\s*–º–∏–Ω/)?.[1] || 0);
                    return getMin(a) - getMin(b);
                });
        } else if (window.UNU_STATE.hourlyOnly) {
            const targets = window.UNU_STATE.targetHours;
            candidateJobs = candidateJobs
                .filter(row => {
                    const status = row.querySelector('.job__status-work')?.textContent || "";
                    const hourMatch = status.match(/(\d+)\s*—á–∞—Å/);
                    if (!hourMatch) return false;
                    const hour = parseInt(hourMatch[1]);
                    return targets.includes(hour);
                })
                .sort((a, b) => {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ—Ä—è–¥–∫—É targetHours
                    const getHour = row => parseInt((row.querySelector('.job__status-work')?.textContent || "").match(/(\d+)\s*—á–∞—Å/)?.[1] || 0);
                    const aHour = getHour(a);
                    const bHour = getHour(b);
                    return targets.indexOf(aHour) - targets.indexOf(bHour);
                });
        } else {
            candidateJobs = candidateJobs.filter(row => {
                const link = row.querySelector('a.job-name')?.href;
                return link && !window.UNU_STATE.openedLinks.has(link);
            });
        }

        if (candidateJobs.length === 0) {
            if (window.UNU_STATE.hourlyOnly) {
                // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–æ–≤–æ–µ –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ (–Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å prev)
                let isNew = false;
                if (window.UNU_STATE.prevOpenedHourlyHours && window.UNU_STATE.prevOpenedHourlyHours.length > 0) {
                    const intersection = window.UNU_STATE.targetHours.filter(h => window.UNU_STATE.prevOpenedHourlyHours.includes(h));
                    isNew = intersection.length === 0;
                } else {
                    isNew = true;
                }
                updateLastOpenedHours(window.UNU_STATE.targetHours, window.UNU_STATE.lastOpenedHourlyCounts, isNew);
            }
            stopOpening();
            return;
        }

        const batchSize = 5;
        let openedThisBatch = 0;
        let hourlyCounts = window.UNU_STATE.lastOpenedHourlyCounts;

        for (let i = 0; i < candidateJobs.length && openedThisBatch < batchSize; i++) {
            const job = candidateJobs[i];
            const linkEl = job.querySelector('a.job-name');
            if (!linkEl) continue;
            const url = linkEl.href;
            if (window.UNU_STATE.openedLinks.has(url)) continue;

            window.UNU_STATE.openedLinks.add(url);
            window.open(url, "_blank");
            openedThisBatch++;

            if (window.UNU_STATE.hourlyOnly) {
                const status = job.querySelector('.job__status-work')?.textContent || "";
                const hourMatch = status.match(/(\d+)\s*—á–∞—Å/);
                if (hourMatch) {
                    const hour = parseInt(hourMatch[1]);
                    hourlyCounts[hour] = (hourlyCounts[hour] || 0) + 1;
                }
            }
        }

        if (window.UNU_STATE.hourlyOnly) {
            // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–æ–≤–æ–µ –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ (–Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å prev)
            let isNew = false;
            if (window.UNU_STATE.prevOpenedHourlyHours && window.UNU_STATE.prevOpenedHourlyHours.length > 0) {
                const intersection = window.UNU_STATE.targetHours.filter(h => window.UNU_STATE.prevOpenedHourlyHours.includes(h));
                isNew = intersection.length === 0;
            } else {
                isNew = true;
            }
            updateLastOpenedHours(window.UNU_STATE.targetHours, hourlyCounts, isNew);
        }

        if (openedThisBatch === 0) {
            if (window.UNU_STATE.hourlyOnly) {
                // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–æ–≤–æ–µ –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ (–Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å prev)
                let isNew = false;
                if (window.UNU_STATE.prevOpenedHourlyHours && window.UNU_STATE.prevOpenedHourlyHours.length > 0) {
                    const intersection = window.UNU_STATE.targetHours.filter(h => window.UNU_STATE.prevOpenedHourlyHours.includes(h));
                    isNew = intersection.length === 0;
                } else {
                    isNew = true;
                }
                updateLastOpenedHours(window.UNU_STATE.targetHours, window.UNU_STATE.lastOpenedHourlyCounts, isNew);
            }
            stopOpening();
            return;
        }

        window.UNU_STATE.timer = setTimeout(processBatch, 2500);
    }

    function highlightJobs() {
        const jobs = document.querySelectorAll('.job-name');
        jobs.forEach(el => {
            const text = el.textContent.toLowerCase();
            if (socialKeywords.some(kw => text.includes(kw))) {
                el.style.backgroundColor = "#ccf2ff";
            }
        });
    }

    function applyTheme(theme) {
        if (theme === "dark") {
            document.body.style.backgroundColor = "#222";
            document.body.style.color = "#eee";
        } else {
            document.body.style.backgroundColor = "";
            document.body.style.color = "";
        }
    }

    function observeDOM() {
        const observer = new MutationObserver(() => {
            highlightJobs();
        });
        observer.observe(document.body, {childList: true, subtree: true});
    }

    // === –ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ ===
    function showTimeCalcModal() {
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –º–æ–¥–∞–ª–∫–∞ ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
        if (document.getElementById('unu-time-calc-modal')) return;
        const modalBg = document.createElement('div');
        modalBg.id = 'unu-time-calc-modal';
        modalBg.style.position = 'fixed';
        modalBg.style.top = '0';
        modalBg.style.left = '0';
        modalBg.style.width = '100vw';
        modalBg.style.height = '100vh';
        modalBg.style.background = 'rgba(0,0,0,0.25)';
        modalBg.style.zIndex = '2000';
        modalBg.style.display = 'flex';
        modalBg.style.alignItems = 'center';
        modalBg.style.justifyContent = 'center';

        // === –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC –∏ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞ ===
        function closeModal() { modalBg.remove(); }
        setTimeout(() => {
            modalBg.addEventListener('click', (e) => {
                if (e.target === modalBg) closeModal();
            });
            window.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    window.removeEventListener('keydown', escHandler);
                }
            });
        }, 0);

        const modal = document.createElement('div');
        modal.style.background = '#fff';
        modal.style.borderRadius = '12px';
        modal.style.padding = '28px 24px 20px 24px';
        modal.style.boxShadow = '0 4px 24px rgba(0,0,0,0.12)';
        modal.style.minWidth = '320px';
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';
        modal.style.alignItems = 'center';
        modal.style.position = 'relative';

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '√ó';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '8px';
        closeBtn.style.right = '12px';
        closeBtn.style.background = 'none';
        closeBtn.style.border = 'none';
        closeBtn.style.fontSize = '22px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.onclick = closeModal;
        modal.appendChild(closeBtn);

        // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const nowStr = pad(now.getHours()) + ':' + pad(now.getMinutes());
        const nowDiv = document.createElement('div');
        nowDiv.textContent = `–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${nowStr}`;
        nowDiv.style.fontSize = '18px';
        nowDiv.style.marginBottom = '16px';
        modal.appendChild(nowDiv);

        // –ü–æ–ª–µ –≤–≤–æ–¥–∞
        const inputDiv = document.createElement('div');
        inputDiv.style.display = 'flex';
        inputDiv.style.alignItems = 'center';
        inputDiv.style.gap = '8px';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = '–ß–∞—Å:–º–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10:30 –∏–ª–∏ 10)';
        input.style.fontSize = '16px';
        input.style.width = '110px';
        input.style.padding = '4px 8px';
        input.style.borderRadius = '6px';
        input.style.border = '1px solid #ccc';
        inputDiv.appendChild(input);
        modal.appendChild(inputDiv);

        // –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å
        const calcBtn = document.createElement('button');
        calcBtn.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å';
        calcBtn.style.marginTop = '16px';
        calcBtn.style.padding = '7px 18px';
        calcBtn.style.background = '#8c4bff';
        calcBtn.style.color = '#fff';
        calcBtn.style.border = 'none';
        calcBtn.style.borderRadius = '7px';
        calcBtn.style.fontSize = '15px';
        calcBtn.style.fontWeight = '600';
        calcBtn.style.cursor = 'pointer';
        modal.appendChild(calcBtn);

        // –†–µ–∑—É–ª—å—Ç–∞—Ç
        const resultDiv = document.createElement('div');
        resultDiv.style.marginTop = '18px';
        resultDiv.style.fontSize = '17px';
        resultDiv.style.fontWeight = '500';
        resultDiv.style.textAlign = 'center';
        modal.appendChild(resultDiv);

        calcBtn.onclick = () => {
            let hour = 0, min = 0;
            const val = input.value.trim();
            if (val.includes(':')) {
                const parts = val.split(':');
                hour = parseInt(parts[0], 10);
                min = parseInt(parts[1], 10);
            } else {
                hour = parseInt(val, 10);
                min = 0;
            }
            if (isNaN(hour) || hour < 0 || hour > 23 || isNaN(min) || min < 0 || min > 59) {
                resultDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è (—á–∞—Å—ã:–º–∏–Ω—É—Ç—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä 10:30 –∏–ª–∏ 10)';
                return;
            }
            const nowH = now.getHours();
            const nowM = now.getMinutes();
            let diffH = hour - nowH;
            let diffM = min - nowM;
            if (diffM < 0) {
                diffM += 60;
                diffH--;
            }
            if (diffH < 0) diffH += 24;
            const totalMins = diffH * 60 + diffM;
            const outH = Math.floor(totalMins / 60);
            const outM = totalMins % 60;
            let text = `–î–æ ${pad(hour)}:${pad(min)} –æ—Å—Ç–∞–ª–æ—Å—å `;
            if (outH > 0) text += `${outH} ${outH === 1 ? '—á–∞—Å' : (outH >= 2 && outH <= 4 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤')}`;
            if (outH > 0 && outM > 0) text += ' ';
            if (outM > 0) text += `${outM} –º–∏–Ω`;
            if (outH === 0 && outM === 0) text = '–í—Ä–µ–º—è —É–∂–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ!';

            // === –ü–æ–¥—Å—á—ë—Ç —á–∞—Å–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Å–∞ ===
            const rows = Array.from(document.querySelectorAll('.job-table__row'));
            let count = 0;
            let matchedHours = [];
            for (const row of rows) {
                const status = row.querySelector('.job__status-work')?.textContent || '';
                let match = status.match(/(\d+)\s*—á–∞—Å/);
                if (match) {
                    const jobHour = parseInt(match[1], 10);
                    if (jobHour <= hour) {
                        count++;
                        matchedHours.push(jobHour);
                    }
                }
            }
            resultDiv.innerHTML = text;
            if (count > 0) {
                // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å
                const showBtn = document.createElement('button');
                showBtn.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å`;
                showBtn.style.marginLeft = '10px';
                showBtn.style.background = '#00bcd4';
                showBtn.style.color = '#fff';
                showBtn.style.border = 'none';
                showBtn.style.borderRadius = '6px';
                showBtn.style.fontSize = '14px';
                showBtn.style.fontWeight = '600';
                showBtn.style.padding = '3px 14px';
                showBtn.style.cursor = 'pointer';
                showBtn.style.transition = 'background 0.2s';
                showBtn.onmouseover = () => showBtn.style.background = '#0097a7';
                showBtn.onmouseout = () => showBtn.style.background = '#00bcd4';
                showBtn.onclick = () => {
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å–µ —á–∞—Å—ã –æ—Ç 1 –¥–æ hour –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
                    const highlightArr = [];
                    for (let i = 1; i <= hour; i++) highlightArr.push(i);
                    showHourCountModal({ highlightHours: highlightArr });
                };
                const infoSpan = document.createElement('span');
                infoSpan.textContent = `–ó–∞–¥–∞–Ω–∏–π –¥–æ ${hour} —á–∞—Å–æ–≤: ${count}`;
                resultDiv.appendChild(document.createElement('br'));
                resultDiv.appendChild(infoSpan);
                resultDiv.appendChild(showBtn);
            }
        };

        modalBg.appendChild(modal);
        document.body.appendChild(modalBg);
    }

    // === –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ –ø–æ —á–∞—Å–∞–º (1‚Äì11) —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è ===
    function showHourCountModal(options = {}) {
        if (document.getElementById('unu-hour-count-modal')) return;
        const highlightHours = options.highlightHours || [];
        const modalBg = document.createElement('div');
        modalBg.id = 'unu-hour-count-modal';
        modalBg.style.position = 'fixed';
        modalBg.style.top = '0';
        modalBg.style.left = '0';
        modalBg.style.width = '100vw';
        modalBg.style.height = '100vh';
        modalBg.style.background = 'rgba(0,0,0,0.18)';
        modalBg.style.zIndex = '2000';
        modalBg.style.display = 'flex';
        modalBg.style.alignItems = 'center';
        modalBg.style.justifyContent = 'center';

        // === –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC –∏ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞ ===
        function closeModal() { modalBg.remove(); }
        setTimeout(() => {
            modalBg.addEventListener('click', (e) => {
                if (e.target === modalBg) closeModal();
            });
            window.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    window.removeEventListener('keydown', escHandler);
                }
            });
        }, 0);

        const modal = document.createElement('div');
        modal.style.background = '#fff';
        modal.style.borderRadius = '14px';
        modal.style.padding = '28px 28px 22px 28px';
        modal.style.boxShadow = '0 4px 32px rgba(0,0,0,0.13)';
        modal.style.minWidth = '370px';
        modal.style.maxWidth = '96vw';
        modal.style.width = '480px';
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';
        modal.style.alignItems = 'center';
        modal.style.position = 'relative';
        modal.style.fontFamily = 'Inter, Arial, sans-serif';

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '√ó';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '10px';
        closeBtn.style.right = '16px';
        closeBtn.style.background = 'none';
        closeBtn.style.border = 'none';
        closeBtn.style.fontSize = '24px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.color = '#888';
        closeBtn.onmouseover = () => closeBtn.style.color = '#00bcd4';
        closeBtn.onmouseout = () => closeBtn.style.color = '#888';
        closeBtn.onclick = closeModal;
        modal.appendChild(closeBtn);

        // === –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å ===
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        refreshBtn.style.position = 'absolute';
        refreshBtn.style.top = '10px';
        refreshBtn.style.left = '16px';
        refreshBtn.style.background = '#00bcd4';
        refreshBtn.style.color = '#fff';
        refreshBtn.style.border = 'none';
        refreshBtn.style.borderRadius = '7px';
        refreshBtn.style.fontSize = '14px';
        refreshBtn.style.fontWeight = '600';
        refreshBtn.style.padding = '4px 16px';
        refreshBtn.style.cursor = 'pointer';
        refreshBtn.style.transition = 'background 0.2s';
        refreshBtn.onmouseover = () => refreshBtn.style.background = '#0097a7';
        refreshBtn.onmouseout = () => refreshBtn.style.background = '#00bcd4';
        refreshBtn.onclick = () => {
            closeModal();
            setTimeout(() => showHourCountModal(options), 10);
        };
        modal.appendChild(refreshBtn);

        // === –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è ===
        const searchDiv = document.createElement('div');
        searchDiv.style.width = '100%';
        searchDiv.style.marginBottom = '10px';
        searchDiv.style.display = 'flex';
        searchDiv.style.justifyContent = 'center';
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = '–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è...';
        searchInput.style.width = '100%';
        searchInput.style.maxWidth = '320px';
        searchInput.style.fontSize = '15px';
        searchInput.style.padding = '7px 12px';
        searchInput.style.borderRadius = '7px';
        searchInput.style.border = '1.5px solid #e0e0e0';
        searchInput.style.margin = '0 auto';
        searchDiv.appendChild(searchInput);
        modal.appendChild(searchDiv);

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const title = document.createElement('div');
        title.textContent = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º';
        title.style.fontSize = '20px';
        title.style.fontWeight = '600';
        title.style.marginBottom = '18px';
        title.style.letterSpacing = '0.2px';
        modal.appendChild(title);

        // –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –ø–æ –≤—Å–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —á–∞—Å–∞–º –∏ –º–∏–Ω—É—Ç–∞–º
        const rows = Array.from(document.querySelectorAll('.job-table__row'));
        const hourCounts = {}, hourRows = {};
        const minCounts = {}, minRows = {};
        let total = 0, totalMin = 0;
        for (const row of rows) {
            const status = row.querySelector('.job__status-work')?.textContent || '';
            let match = status.match(/(\d+)\s*—á–∞—Å/);
            if (match) {
                const hour = parseInt(match[1], 10);
                if (!hourCounts[hour]) { hourCounts[hour] = 0; hourRows[hour] = []; }
                hourCounts[hour]++;
                hourRows[hour].push(row);
                total++;
            }
            match = status.match(/(\d+)\s*–º–∏–Ω/);
            if (match) {
                const min = parseInt(match[1], 10);
                if (!minCounts[min]) { minCounts[min] = 0; minRows[min] = []; }
                minCounts[min]++;
                minRows[min].push(row);
                totalMin++;
            }
        }
        const uniqueHours = Object.keys(hourCounts).map(Number).sort((a, b) => a - b);
        const uniqueMins = Object.keys(minCounts).map(Number).sort((a, b) => a - b);

        // –û–±—â–∞—è —Å—Ç—Ä–æ–∫–∞
        const totalDiv = document.createElement('div');
        totalDiv.textContent = `–í—Å–µ–≥–æ —á–∞—Å–æ–≤—ã—Ö: ${total}   |   –í—Å–µ–≥–æ –º–∏–Ω—É—Ç–Ω—ã—Ö: ${totalMin}`;
        totalDiv.style.fontSize = '16px';
        totalDiv.style.fontWeight = '500';
        totalDiv.style.marginBottom = '10px';
        totalDiv.style.alignSelf = 'flex-start';
        modal.appendChild(totalDiv);

        // === –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —á–∞—Å—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è ===
        if (highlightHours.length > 0) {
            let selectedCount = 0;
            for (const h of highlightHours) {
                selectedCount += hourCounts[h] || 0;
            }
            const leftCount = total - selectedCount;
            const infoDiv = document.createElement('div');
            infoDiv.style.fontSize = '15px';
            infoDiv.style.fontWeight = '500';
            infoDiv.style.marginBottom = '8px';
            infoDiv.style.alignSelf = 'flex-start';
            infoDiv.style.color = '#ff9800';
            infoDiv.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${leftCount} (—Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–æ ${Math.max(...highlightHours)} —á–∞—Å–æ–≤)`;
            modal.appendChild(infoDiv);
        }
        // === –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ===
        const allTotal = total + totalMin;
        const allDiv = document.createElement('div');
        allDiv.style.fontSize = '15px';
        allDiv.style.fontWeight = '500';
        allDiv.style.marginBottom = '8px';
        allDiv.style.alignSelf = 'flex-start';
        allDiv.style.color = '#00bcd4';
        allDiv.textContent = `–û–±—â–µ–µ: ${allTotal} (—á–∞—Å–æ–≤—ã—Ö: ${total}, –º–∏–Ω—É—Ç–Ω—ã—Ö: ${totalMin})`;
        modal.appendChild(allDiv);

        // –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü
        const scrollArea = document.createElement('div');
        scrollArea.style.maxHeight = '60vh';
        scrollArea.style.overflowY = 'auto';
        scrollArea.style.width = '100%';
        scrollArea.style.marginBottom = '8px';
        scrollArea.style.borderRadius = '8px';
        scrollArea.style.background = '#fafbfc';
        scrollArea.style.padding = '2px 0 2px 0';

        // –¢–∞–±–ª–∏—Ü–∞ —á–∞—Å–æ–≤—ã—Ö
        if (uniqueHours.length > 0) {
            const hourTitle = document.createElement('div');
            hourTitle.textContent = '–ß–∞—Å—ã';
            hourTitle.style.fontSize = '15px';
            hourTitle.style.fontWeight = '600';
            hourTitle.style.margin = '10px 0 4px 0';
            hourTitle.style.paddingLeft = '2px';
            scrollArea.appendChild(hourTitle);

            const table = document.createElement('div');
            table.style.display = 'grid';
            table.style.gridTemplateColumns = '110px 1fr 120px';
            table.style.gap = '0 10px';
            table.style.width = '100%';
            table.style.marginBottom = '8px';
            for (const h of uniqueHours) {
                const hourCell = document.createElement('div');
                hourCell.textContent = `${h} —á–∞—Å${h === 1 ? '' : (h >= 2 && h <= 4 ? '–∞' : '–æ–≤')}`;
                hourCell.style.fontSize = '15px';
                hourCell.style.color = '#222';
                hourCell.style.padding = '10px 0 10px 0';
                hourCell.style.borderBottom = '1px solid #f0f0f0';
                // === –í—ã–¥–µ–ª–µ–Ω–∏–µ –Ω—É–∂–Ω—ã—Ö —á–∞—Å–æ–≤ ===
                if (highlightHours.includes(h)) {
                    hourCell.style.background = '#ffe082';
                }
                table.appendChild(hourCell);
                const countCell = document.createElement('div');
                countCell.textContent = `${hourCounts[h]} –∑–∞–¥–∞–Ω–∏–π`;
                countCell.style.fontSize = '15px';
                countCell.style.color = hourCounts[h] > 0 ? '#00bcd4' : '#aaa';
                countCell.style.padding = '10px 0 10px 0';
                countCell.style.borderBottom = '1px solid #f0f0f0';
                if (highlightHours.includes(h)) {
                    countCell.style.background = '#ffe082';
                }
                table.appendChild(countCell);
                const btnWrap = document.createElement('div');
                btnWrap.style.display = 'flex';
                btnWrap.style.flexDirection = 'row';
                btnWrap.style.alignItems = 'center';
                btnWrap.style.gap = '8px';
                btnWrap.style.minWidth = '120px';
                btnWrap.style.overflow = 'visible';
                if (highlightHours.includes(h)) {
                    btnWrap.style.background = '#ffe082';
                }
                const btn = document.createElement('button');
                btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
                btn.style.background = hourCounts[h] > 0 ? 'linear-gradient(90deg, #00bcd4 80%, #fff0 100%)' : '#f3f3f3';
                btn.style.color = hourCounts[h] > 0 ? '#fff' : '#bbb';
                btn.style.border = 'none';
                btn.style.borderRadius = '7px';
                btn.style.cursor = hourCounts[h] > 0 ? 'pointer' : 'not-allowed';
                btn.style.fontSize = '14px';
                btn.style.fontWeight = '600';
                btn.style.padding = '6px 0';
                btn.style.width = '110px';
                btn.style.boxShadow = 'none';
                btn.style.transition = 'background 0.2s';
                btn.disabled = hourCounts[h] === 0;
                btn.onclick = (e) => {
                    if (hourCounts[h] === 0 || btn.disabled) return;
                    openHourJobs(hourRows[h], e, btn, h, hourCounts[h], totalDiv);
                };
                btnWrap.appendChild(btn);
                table.appendChild(btnWrap);
            }
            scrollArea.appendChild(table);
        }

        // –¢–∞–±–ª–∏—Ü–∞ –º–∏–Ω—É—Ç–Ω—ã—Ö
        if (uniqueMins.length > 0) {
            const minTitleRow = document.createElement('div');
            minTitleRow.style.display = 'flex';
            minTitleRow.style.alignItems = 'center';
            minTitleRow.style.justifyContent = 'space-between';
            minTitleRow.style.margin = '16px 0 4px 0';
            minTitleRow.style.width = '100%';

            const minTitle = document.createElement('div');
            minTitle.textContent = '–ú–∏–Ω—É—Ç—ã';
            minTitle.style.fontSize = '15px';
            minTitle.style.fontWeight = '600';
            minTitle.style.paddingLeft = '2px';
            minTitleRow.appendChild(minTitle);

            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –º–∏–Ω—É—Ç–Ω—ã–µ
            const openAllBtn = document.createElement('button');
            openAllBtn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –º–∏–Ω—É—Ç–Ω—ã–µ';
            openAllBtn.style.background = 'linear-gradient(90deg, #00bcd4 80%, #fff0 100%)';
            openAllBtn.style.color = '#fff';
            openAllBtn.style.border = 'none';
            openAllBtn.style.borderRadius = '7px';
            openAllBtn.style.cursor = 'pointer';
            openAllBtn.style.fontSize = '13px';
            openAllBtn.style.fontWeight = '600';
            openAllBtn.style.padding = '6px 14px';
            openAllBtn.style.boxShadow = 'none';
            openAllBtn.style.transition = 'background 0.2s';
            openAllBtn.onclick = (e) => {
                if (openAllBtn.disabled) return;
                let allMinRows = [];
                for (const m of uniqueMins) allMinRows = allMinRows.concat(minRows[m]);
                openHourJobs(allMinRows, e, openAllBtn);
            };
            minTitleRow.appendChild(openAllBtn);
            scrollArea.appendChild(minTitleRow);

            const table = document.createElement('div');
            table.style.display = 'grid';
            table.style.gridTemplateColumns = '110px 1fr 120px';
            table.style.gap = '0 10px';
            table.style.width = '100%';
            table.style.marginBottom = '8px';
            for (const m of uniqueMins) {
                const minCell = document.createElement('div');
                minCell.textContent = `${m} –º–∏–Ω`;
                minCell.style.fontSize = '15px';
                minCell.style.color = '#222';
                minCell.style.padding = '10px 0 10px 0';
                minCell.style.borderBottom = '1px solid #f0f0f0';
                table.appendChild(minCell);
                const countCell = document.createElement('div');
                countCell.textContent = `${minCounts[m]} –∑–∞–¥–∞–Ω–∏–π`;
                countCell.style.fontSize = '15px';
                countCell.style.color = minCounts[m] > 0 ? '#00bcd4' : '#aaa';
                countCell.style.padding = '10px 0 10px 0';
                countCell.style.borderBottom = '1px solid #f0f0f0';
                table.appendChild(countCell);
                const btnWrap = document.createElement('div');
                btnWrap.style.display = 'flex';
                btnWrap.style.flexDirection = 'row';
                btnWrap.style.alignItems = 'center';
                btnWrap.style.gap = '8px';
                btnWrap.style.minWidth = '120px';
                btnWrap.style.overflow = 'visible';

                const btn = document.createElement('button');
                btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
                btn.style.background = minCounts[m] > 0 ? 'linear-gradient(90deg, #00bcd4 80%, #fff0 100%)' : '#f3f3f3';
                btn.style.color = minCounts[m] > 0 ? '#fff' : '#bbb';
                btn.style.border = 'none';
                btn.style.borderRadius = '7px';
                btn.style.cursor = minCounts[m] > 0 ? 'pointer' : 'not-allowed';
                btn.style.fontSize = '14px';
                btn.style.fontWeight = '600';
                btn.style.padding = '6px 0';
                btn.style.width = '110px';
                btn.style.boxShadow = 'none';
                btn.style.transition = 'background 0.2s';
                btn.disabled = minCounts[m] === 0;
                btn.onclick = (e) => {
                    if (minCounts[m] === 0 || btn.disabled) return;
                    openHourJobs(minRows[m], e, btn);
                };
                btnWrap.appendChild(btn);
                table.appendChild(btnWrap);
            }
            scrollArea.appendChild(table);
        }

        modal.appendChild(scrollArea);

        // –ü–æ–¥–ø–∏—Å—å
        const note = document.createElement('div');
        note.textContent = '–û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ 5 –∑–∞–¥–∞–Ω–∏–π –∑–∞ —Ä–∞–∑.';
        note.style.fontSize = '13px';
        note.style.color = '#888';
        note.style.marginTop = '12px';
        note.style.textAlign = 'center';
        modal.appendChild(note);

        modalBg.appendChild(modal);
        document.body.appendChild(modalBg);
    }

    // === –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ" –ø–æ —á–∞—Å–∞–º ===
    function showVerificationCountModal() {
        if (document.getElementById('unu-verification-count-modal')) return;
        const modalBg = document.createElement('div');
        modalBg.id = 'unu-verification-count-modal';
        modalBg.style.position = 'fixed';
        modalBg.style.top = '0';
        modalBg.style.left = '0';
        modalBg.style.width = '100vw';
        modalBg.style.height = '100vh';
        modalBg.style.background = 'rgba(0,0,0,0.18)';
        modalBg.style.zIndex = '2000';
        modalBg.style.display = 'flex';
        modalBg.style.alignItems = 'center';
        modalBg.style.justifyContent = 'center';

        // === –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC –∏ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞ ===
        function closeModal() { modalBg.remove(); }
        setTimeout(() => {
            modalBg.addEventListener('click', (e) => {
                if (e.target === modalBg) closeModal();
            });
            window.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    window.removeEventListener('keydown', escHandler);
                }
            });
        }, 0);

        let minuteEndTimes = {};

        // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º modal
        const modal = document.createElement('div');
        modal.style.background = '#fff';
        modal.style.borderRadius = '14px';
        modal.style.padding = '28px 28px 22px 28px';
        modal.style.boxShadow = '0 4px 32px rgba(0,0,0,0.13)';
        modal.style.minWidth = '370px';
        modal.style.maxWidth = '96vw';
        modal.style.width = '420px';
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';
        modal.style.alignItems = 'center';
        modal.style.position = 'relative';
        modal.style.fontFamily = 'Inter, Arial, sans-serif';
        modal.style.maxHeight = '600px'; // —É–≤–µ–ª–∏—á–∏–ª–∏ –≤—ã—Å–æ—Ç—É –º–æ–¥–∞–ª–∫–∏

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '√ó';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '10px';
        closeBtn.style.right = '16px';
        closeBtn.style.background = 'none';
        closeBtn.style.border = 'none';
        closeBtn.style.fontSize = '24px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.color = '#888';
        closeBtn.onmouseover = () => closeBtn.style.color = '#ffb300';
        closeBtn.onmouseout = () => closeBtn.style.color = '#888';
        closeBtn.onclick = closeModal;
        modal.appendChild(closeBtn);

        // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        refreshBtn.style.position = 'absolute';
        refreshBtn.style.top = '10px';
        refreshBtn.style.left = '16px';
        refreshBtn.style.background = '#ffb300';
        refreshBtn.style.color = '#fff';
        refreshBtn.style.border = 'none';
        refreshBtn.style.borderRadius = '7px';
        refreshBtn.style.fontSize = '14px';
        refreshBtn.style.fontWeight = '600';
        refreshBtn.style.padding = '4px 16px';
        refreshBtn.style.cursor = 'pointer';
        refreshBtn.style.transition = 'background 0.2s';
        refreshBtn.onmouseover = () => refreshBtn.style.background = '#ff9800';
        refreshBtn.onmouseout = () => refreshBtn.style.background = '#ffb300';
        refreshBtn.onclick = () => {
            closeModal();
            setTimeout(() => showVerificationCountModal(), 10);
        };
        modal.appendChild(refreshBtn);

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const title = document.createElement('div');
        title.textContent = '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ —á–∞—Å–∞–º';
        title.style.fontSize = '20px';
        title.style.fontWeight = '600';
        title.style.marginBottom = '18px';
        title.style.letterSpacing = '0.2px';
        modal.appendChild(title);

        // === –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –º–æ–¥–∞–ª–∫–µ ===
        let intervalId = null;
        function renderModalContent() {
            // –û—á–∏—â–∞–µ–º –º–æ–¥–∞–ª–∫—É –∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            while (modal.children.length > 3) modal.removeChild(modal.lastChild);

            // --- –í —Ä–∞–±–æ—Ç–µ - –í—Å–µ–≥–æ ---
            const counterDiff = document.querySelector('#unu-task-opener-ui div[style*="b800ff"]');
            const diffDiv = document.createElement('div');
            diffDiv.textContent = counterDiff ? counterDiff.textContent : '';
            diffDiv.style.fontSize = '15px';
            diffDiv.style.fontWeight = '600';
            diffDiv.style.marginBottom = '8px';
            diffDiv.style.color = '#b800ff';
            diffDiv.style.alignSelf = 'flex-start';
            modal.appendChild(diffDiv);

            // –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ —á–∞—Å–∞–º –∏ –º–∏–Ω—É—Ç–∞–º
            const verifEls = Array.from(document.querySelectorAll('.job__status-verification'));
            const hourCounts = {}, minCounts = {};
            let total = 0;
            let sumTotal = 0;
            const now = new Date();
            for (const el of verifEls) {
                // –ß–∞—Å—ã
                const matchHour = el.textContent.match(/–æ—Å—Ç–∞–ª–æ—Å—å\s*(\d+)\s*—á–∞—Å/);
                if (matchHour) {
                    const hour = parseInt(matchHour[1], 10);
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è (–µ—Å–ª–∏ —á–∞—Å < —Ç–µ–∫—É—â–µ–≥–æ –∏ –Ω–µ—Ç '(–∑–∞–≤—Ç—Ä–∞)')
                    let row = el.closest('.job-table__row');
                    let expired = false;
                    if (row) {
                        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ data-–∞—Ç—Ä–∏–±—É—Ç –∏–ª–∏ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –µ—Å–ª–∏ –µ—Å—Ç—å)
                        // –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ç–µ–∫—É—â–∏–º —á–∞—Å–æ–º
                        const nowHour = now.getHours();
                        if (hour < nowHour) expired = true;
                    }
                    if (!expired) {
                        if (!hourCounts[hour]) hourCounts[hour] = 0;
                        hourCounts[hour]++;
                        total++;
                    }
                }
                // –ú–∏–Ω—É—Ç—ã
                const matchMin = el.textContent.match(/–æ—Å—Ç–∞–ª–æ—Å—å\s*(\d+)\s*–º–∏–Ω/);
                if (matchMin) {
                    const min = parseInt(matchMin[1], 10);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è
                    let row = el.closest('.job-table__row');
                    let expired = false;
                    if (row) {
                        // –î–ª—è –º–∏–Ω—É—Ç —Å—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        let created = null;
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º, –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                        // (–í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ —Å—á–∏—Ç–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç.–∫. –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è)
                        // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: now + min –º–∏–Ω—É—Ç
                        // –ù–æ –Ω–∞–º –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ —ç—Ç–æ –≤—Ä–µ–º—è
                        // –î–ª—è —ç—Ç–æ–≥–æ –∏—â–µ–º –≤ DOM, –µ—Å—Ç—å –ª–∏ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, data-start –∏–ª–∏ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ)
                        // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ min –º–∏–Ω—É—Ç —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
                        // –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º: –µ—Å–ª–∏ min == 0, —Ç–æ —É–∂–µ –∏—Å—Ç–µ–∫–ª–æ
                    }
                    if (!expired) {
                        if (!minCounts[min]) minCounts[min] = 0;
                        minCounts[min]++;
                        total++;
                    }
                }
                // –°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã (–∏—â–µ–º .sum –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ)
                let row = el.closest('.job-table__row');
                if (row) {
                    let sumEl = row.querySelector('.sum');
                    if (sumEl) {
                        let val = parseFloat((sumEl.textContent || '').replace(/[^\d.,]/g, '').replace(',', '.'));
                        if (!isNaN(val)) sumTotal += val;
                    }
                }
            }
            const uniqueMins = Object.keys(minCounts).map(Number).sort((a, b) => a - b);
            const uniqueHours = Object.keys(hourCounts).map(Number).sort((a, b) => a - b);

            // –û–±—â–∞—è —Å—Ç—Ä–æ–∫–∞
            const totalDiv = document.createElement('div');
            totalDiv.textContent = `–í—Å–µ–≥–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${total}`;
            totalDiv.style.fontSize = '16px';
            totalDiv.style.fontWeight = '500';
            totalDiv.style.marginBottom = '10px';
            totalDiv.style.alignSelf = 'flex-start';
            modal.appendChild(totalDiv);
            // === –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å –∏ —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è ===
            console.log('[UNU] –í—Å–µ–≥–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è):', total);

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü
            let scrollArea = modal.querySelector('.unu-verif-scroll-area');
            let prevScrollTop = 0;
            if (scrollArea) {
                prevScrollTop = scrollArea.scrollTop;
                scrollArea.remove();
            }
            scrollArea = document.createElement('div');
            scrollArea.className = 'unu-verif-scroll-area';
            scrollArea.style.maxHeight = '350px'; // —É–≤–µ–ª–∏—á–∏–ª–∏ –≤—ã—Å–æ—Ç—É —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            scrollArea.style.overflowY = 'auto';
            scrollArea.style.width = '100%';
            scrollArea.style.marginBottom = '8px';
            scrollArea.style.borderRadius = '8px';
            scrollArea.style.background = '#fafbfc';
            scrollArea.style.padding = '2px 0 2px 0';

            // –°–Ω–∞—á–∞–ª–∞ –º–∏–Ω—É—Ç–Ω—ã–µ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
            if (uniqueMins.length > 0) {
                const minTitle = document.createElement('div');
                minTitle.textContent = '–ú–∏–Ω—É—Ç—ã';
                minTitle.style.fontSize = '15px';
                minTitle.style.fontWeight = '600';
                minTitle.style.paddingLeft = '2px';
                minTitle.style.margin = '10px 0 4px 0';
                scrollArea.appendChild(minTitle);

                const table = document.createElement('div');
                table.style.display = 'grid';
                table.style.gridTemplateColumns = '1fr 1fr';
                table.style.gap = '0 10px';
                table.style.width = '100%';
                table.style.marginBottom = '8px';
                const now = new Date();
                const nowHour = now.getHours();
                const nowMin = now.getMinutes();
                for (const m of uniqueMins) {
                    let count = minCounts[m];
                    // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø–æ–º–Ω–∏–ª–∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
                    if (!minuteEndTimes[m]) {
                        const now = new Date();
                        const endDate = new Date(now.getTime() + parseInt(m) * 60000);
                        minuteEndTimes[m] = endDate;
                    }
                    const endDate = minuteEndTimes[m];
                    const endHour = endDate.getHours();
                    const endMin = endDate.getMinutes();
                    const endStr = `${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}`;
                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    console.log(`[UNU] –ú–∏–Ω—É—Ç–Ω—ã–µ: —Å–µ–π—á–∞—Å ${nowHour.toString().padStart(2,'0')}:${nowMin.toString().padStart(2,'0')}, m=${m}, endHour=${endHour}, endMin=${endMin}`);
                    const minCell = document.createElement('div');
                    minCell.textContent = `${m} –º–∏–Ω (–∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –≤ ${endStr})`;
                    minCell.style.fontSize = '15px';
                    minCell.style.color = '#222';
                    minCell.style.padding = '16px 0 16px 0';
                    minCell.style.borderBottom = '1px solid #f0f0f0';
                    table.appendChild(minCell);
                    const countCell = document.createElement('div');
                    countCell.textContent = `${count}`;
                    countCell.style.fontSize = '15px';
                    countCell.style.color = '#ffb300';
                    countCell.style.padding = '16px 0 16px 0';
                    countCell.style.borderBottom = '1px solid #f0f0f0';
                    table.appendChild(countCell);
                }
                scrollArea.appendChild(table);
            }

            // –ó–∞—Ç–µ–º —á–∞—Å–æ–≤—ã–µ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
            if (uniqueHours.length > 0) {
                const hourTitle = document.createElement('div');
                hourTitle.textContent = '–ß–∞—Å—ã';
                hourTitle.style.fontSize = '15px';
                hourTitle.style.fontWeight = '600';
                hourTitle.style.paddingLeft = '2px';
                hourTitle.style.margin = '10px 0 4px 0';
                scrollArea.appendChild(hourTitle);

                const table = document.createElement('div');
                table.style.display = 'grid';
                table.style.gridTemplateColumns = '1fr 1fr';
                table.style.gap = '0 10px';
                table.style.width = '100%';
                table.style.marginBottom = '8px';
                const now = new Date();
                const nowHour = now.getHours();
                for (const h of uniqueHours) {
                    let hourVal = parseInt(h);
                    let endHour = hourVal;
                    let dayShift = '';
                    if (hourVal < nowHour) {
                        // –∑–∞–≤—Ç—Ä–∞
                        dayShift = ' (–∑–∞–≤—Ç—Ä–∞)';
                    }
                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    console.log(`[UNU] –ß–∞—Å–æ–≤—ã–µ: —Å–µ–π—á–∞—Å ${nowHour.toString().padStart(2,'0')}:00, h=${h}, endHour=${endHour}${dayShift}`);
                    const endStr = `${endHour.toString().padStart(2, '0')}:00${dayShift}`;
                    const hourCell = document.createElement('div');
                    hourCell.textContent = `${h} —á–∞—Å${h === 1 ? '' : (h >= 2 && h <= 4 ? '–∞' : '–æ–≤')} (–∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –≤ ${endStr})`;
                    hourCell.style.fontSize = '15px';
                    hourCell.style.color = '#222';
                    hourCell.style.padding = '16px 0 16px 0';
                    hourCell.style.borderBottom = '1px solid #f0f0f0';
                    table.appendChild(hourCell);
                    const countCell = document.createElement('div');
                    countCell.textContent = `${hourCounts[h]}`;
                    countCell.style.fontSize = '15px';
                    countCell.style.color = '#ffb300';
                    countCell.style.padding = '16px 0 16px 0';
                    countCell.style.borderBottom = '1px solid #f0f0f0';
                    table.appendChild(countCell);
                }
                scrollArea.appendChild(table);
            }

            modal.appendChild(scrollArea);

            // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú scrollTop –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            setTimeout(() => { scrollArea.scrollTop = prevScrollTop; }, 0);

            // –°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç
            const sumDiv = document.createElement('div');
            sumDiv.textContent = `–°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${sumTotal.toFixed(2)} —Ä—É–±`;
            sumDiv.style.fontSize = '15px';
            sumDiv.style.fontWeight = '500';
            sumDiv.style.marginTop = '8px';
            sumDiv.style.color = '#009688';
            sumDiv.style.alignSelf = 'flex-start';
            modal.appendChild(sumDiv);

            // === –ù–æ–≤—ã–π –±–ª–æ–∫: —Å–∫–æ–ª—å–∫–æ "–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ" —Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω ===
            let onlineCount = 0;
            let debugOnline = [];
            for (const el of verifEls) {
                let row = el.closest('.job-table__row');
                if (row) {
                    // –∏—â–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userLink = row.querySelector('.job-table__cell a[href^="https://unu.im/users/"]');
                    let found = false;
                    let userLinkHTML = userLink ? userLink.outerHTML : null;
                    if (userLink && userLink.querySelector('img.online_bubble')) {
                        found = true;
                        onlineCount++;
                    }
                    debugOnline.push({
                        row: row,
                        foundOnline: found,
                        userLinkHTML: userLinkHTML,
                        rowHTML: row ? row.outerHTML : null
                    });
                }
            }
            console.log('[UNU] –û–Ω–ª–∞–π–Ω-–ø–æ–¥—Å—á—ë—Ç: –≤—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ:', verifEls.length);
            debugOnline.forEach((item, idx) => {
                console.log(`[UNU] –°—Ç—Ä–æ–∫–∞ ${idx+1}: –Ω–∞–π–¥–µ–Ω –æ–Ω–ª–∞–π–Ω?`, item.foundOnline, item.userLinkHTML);
            });
            console.log('[UNU] –ò—Ç–æ–≥–æ–≤—ã–π –æ–Ω–ª–∞–π–Ω-–∫–∞—É–Ω—Ç:', onlineCount);
            const onlineDiv = document.createElement('div');
            onlineDiv.textContent = `–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: ${onlineCount}`;
            onlineDiv.style.fontSize = '15px';
            onlineDiv.style.fontWeight = '500';
            onlineDiv.style.marginTop = '4px';
            onlineDiv.style.color = '#4b83ff';
            onlineDiv.style.alignSelf = 'flex-start';
            modal.appendChild(onlineDiv);

            // –ü–æ–¥–ø–∏—Å—å
            const note = document.createElement('div');
            note.textContent = '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–∏–Ω—É—Ç –∏ —á–∞—Å–æ–≤.';
            note.style.fontSize = '13px';
            note.style.color = '#888';
            note.style.marginTop = '12px';
            note.style.textAlign = 'center';
            modal.appendChild(note);
        }

        // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
        renderModalContent();
        intervalId = setInterval(renderModalContent, 1000);

        // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        function closeModal() {
            modalBg.remove();
            if (intervalId) clearInterval(intervalId);
        }
        setTimeout(() => {
            modalBg.addEventListener('click', (e) => {
                if (e.target === modalBg) closeModal();
            });
            window.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    window.removeEventListener('keydown', escHandler);
                }
            });
        }, 0);

        modalBg.appendChild(modal);
        document.body.appendChild(modalBg);
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞–Ω–∏–π –ø–æ 5 –∑–∞ —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    function openHourJobs(rows, event, btnToDisable, hourValue, hourCount, totalDiv) {
        const links = rows.map(row => row.querySelector('a.job-name')?.href).filter(Boolean);
        let idx = 0;
        const seamless = event && (event.metaKey || event.ctrlKey);
        function openLink(url) {
            if (seamless) {
                // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ <a>
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => a.remove(), 100);
                try { window.focus(); } catch(e){}
            } else {
                window.open(url, '_blank');
            }
        }
        function openBatch() {
            let opened = 0;
            while (idx < links.length && opened < 5) {
                openLink(links[idx]);
                idx++;
                opened++;
            }
            if (idx < links.length) {
                setTimeout(openBatch, 2500);
            }
        }
        openBatch();
        if (btnToDisable) {
            btnToDisable.disabled = true;
            btnToDisable.textContent = '–û—Ç–∫—Ä—ã—Ç–æ';
            btnToDisable.style.background = '#e0e0e0';
            btnToDisable.style.color = '#aaa';
            btnToDisable.style.cursor = 'not-allowed';
            btnToDisable.style.border = 'none';
            btnToDisable.style.boxShadow = 'none';
            btnToDisable.style.fontWeight = '500';
            btnToDisable.style.transition = 'all 0.25s';
            let unlockBtn = document.createElement('button');
            unlockBtn.textContent = '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            unlockBtn.style.marginLeft = '8px';
            unlockBtn.style.background = '#fff';
            unlockBtn.style.color = '#00bcd4';
            unlockBtn.style.border = '1px solid #00bcd4';
            unlockBtn.style.borderRadius = '6px';
            unlockBtn.style.fontSize = '12px';
            unlockBtn.style.fontWeight = '600';
            unlockBtn.style.padding = '3px 10px';
            unlockBtn.style.cursor = 'pointer';
            unlockBtn.style.transition = 'all 0.2s';
            unlockBtn.onmouseover = () => {
                unlockBtn.style.background = '#00bcd4';
                unlockBtn.style.color = '#fff';
            };
            unlockBtn.onmouseout = () => {
                unlockBtn.style.background = '#fff';
                unlockBtn.style.color = '#00bcd4';
            };
            if (btnToDisable.parentNode && btnToDisable.parentNode.style.display === 'flex') {
                btnToDisable.parentNode.appendChild(unlockBtn);
            } else {
                btnToDisable.parentNode.insertBefore(unlockBtn, btnToDisable.nextSibling);
            }
            unlockBtn.onclick = () => {
                btnToDisable.disabled = false;
                btnToDisable.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
                btnToDisable.style.background = 'linear-gradient(90deg, #00bcd4 80%, #fff0 100%)';
                btnToDisable.style.color = '#fff';
                btnToDisable.style.cursor = 'pointer';
                btnToDisable.style.border = 'none';
                btnToDisable.style.boxShadow = 'none';
                btnToDisable.style.fontWeight = '600';
                btnToDisable.style.transition = 'background 0.2s';
                unlockBtn.remove();
            };
            // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Å–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π ===
            if (typeof hourValue === 'number' && typeof hourCount === 'number' && totalDiv) {
                let match = totalDiv.textContent.match(/–í—Å–µ–≥–æ —á–∞—Å–æ–≤—ã—Ö: (\d+)/);
                if (match) {
                    let totalNow = parseInt(match[1], 10);
                    let newTotal = totalNow - hourCount;
                    if (newTotal < 0) newTotal = 0;
                    totalDiv.textContent = `–í—Å–µ–≥–æ —á–∞—Å–æ–≤—ã—Ö: ${newTotal}   |   ` + totalDiv.textContent.split('|')[1];
                }
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è id –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Å—Å—ã–ª–∫–∏
    function getJobId(row) {
        const a = row.querySelector('.job-name');
        if (!a) return null;
        const match = a.href.match(/report\/(\d+)\//);
        return match ? match[1] : null;
    }

    // –ö–ª—é—á –¥–ª—è localStorage
    const LS_KEY = 'highlighted_jobs_fail';

    // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö id
    function getHighlighted() {
        try {
            return JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        } catch {
            return [];
        }
    }
    function setHighlighted(arr) {
        localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    function setupHighlightButtons() {
        const highlighted = getHighlighted();
        document.querySelectorAll('.job-table__row').forEach(row => {
            const jobId = getJobId(row);
            if (!jobId) return;

            // –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
            if (row.querySelector('.highlight-btn-fail')) return;

            // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
            const btn = document.createElement('button');
            btn.textContent = '–ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å';
            btn.className = 'highlight-btn-fail';
            btn.style.marginLeft = '10px';
            btn.style.padding = '3px 10px';
            btn.style.borderRadius = '6px';
            btn.style.background = '#ffe082';
            btn.style.color = '#333';
            btn.style.border = '1px solid #ffb300';
            btn.style.cursor = 'pointer';
            btn.style.fontSize = '13px';

            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–∏—Ç—å
            const delBtn = document.createElement('button');
            delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            delBtn.className = 'remove-highlight-btn-fail';
            delBtn.style.marginLeft = '10px';
            delBtn.style.padding = '3px 10px';
            delBtn.style.borderRadius = '6px';
            delBtn.style.background = '#ffb3b3';
            delBtn.style.color = '#333';
            delBtn.style.border = '1px solid #ff3333';
            delBtn.style.cursor = 'pointer';
            delBtn.style.fontSize = '13px';
            delBtn.style.display = 'none';

            // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É
            const firstCell = row.querySelector('.job-table__cell');
            if (firstCell) {
                firstCell.appendChild(btn);
                firstCell.appendChild(delBtn);
            }

            // –ï—Å–ª–∏ —É–∂–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω–æ ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–∏—Ç—å
            if (highlighted.includes(jobId)) {
                row.style.boxShadow = '0 0 0 3px #ffe082';
                row.style.background = '#fffde7';
                btn.style.display = 'none';
                delBtn.style.display = '';
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            btn.onclick = () => {
                const arr = getHighlighted();
                if (!arr.includes(jobId)) {
                    arr.push(jobId);
                    setHighlighted(arr);
                }
                row.style.boxShadow = '0 0 0 3px #ffe082';
                row.style.background = '#fffde7';
                btn.style.display = 'none';
                delBtn.style.display = '';
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
            delBtn.onclick = () => {
                let arr = getHighlighted();
                arr = arr.filter(id => id !== jobId);
                setHighlighted(arr);
                row.style.boxShadow = '';
                row.style.background = '';
                btn.style.display = '';
                delBtn.style.display = 'none';
            };
        });
    }

    // –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ DOM (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è)
    setupHighlightButtons();
    const observer = new MutationObserver(setupHighlightButtons);
    observer.observe(document.body, {childList: true, subtree: true});

    // –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ DOM (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è)
    if (window.location.pathname === '/tasks/works/fail') {
        function applyHighlightStyle(row) {
            row.style.boxShadow = '0 0 0 4px #b800c6, 0 0 12px 2px #db64df';
            row.style.background = '#db64df';
            row.style.transition = 'box-shadow 0.2s, background 0.2s';
        }
        function removeHighlightStyle(row) {
            row.style.boxShadow = '';
            row.style.background = '';
            row.style.transition = '';
        }
        function setupHighlightButtons() {
            const highlighted = getHighlighted();
            document.querySelectorAll('.job-table__row').forEach(row => {
                const jobId = getJobId(row);
                if (!jobId) return;
                if (row.querySelector('.highlight-btn-fail')) return;
                const btn = document.createElement('button');
                btn.textContent = '–ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å';
                btn.className = 'highlight-btn-fail';
                btn.style.marginLeft = '10px';
                btn.style.padding = '3px 10px';
                btn.style.borderRadius = '6px';
                btn.style.background = '#fff200';
                btn.style.color = '#333';
                btn.style.border = '2px solid #ffb300';
                btn.style.cursor = 'pointer';
                btn.style.fontSize = '13px';
                btn.style.fontWeight = 'bold';
                const delBtn = document.createElement('button');
                delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                delBtn.className = 'remove-highlight-btn-fail';
                delBtn.style.marginLeft = '10px';
                delBtn.style.padding = '3px 10px';
                delBtn.style.borderRadius = '6px';
                delBtn.style.background = '#ffb3b3';
                delBtn.style.color = '#333';
                delBtn.style.border = '2px solid #ff3333';
                delBtn.style.cursor = 'pointer';
                delBtn.style.fontSize = '13px';
                delBtn.style.fontWeight = 'bold';
                delBtn.style.display = 'none';
                const firstCell = row.querySelector('.job-table__cell');
                if (firstCell) {
                    firstCell.appendChild(btn);
                    firstCell.appendChild(delBtn);
                }
                if (highlighted.includes(jobId)) {
                    applyHighlightStyle(row);
                    btn.style.display = 'none';
                    delBtn.style.display = '';
                }
                btn.onclick = () => {
                    const arr = getHighlighted();
                    if (!arr.includes(jobId)) {
                        arr.push(jobId);
                        setHighlighted(arr);
                    }
                    applyHighlightStyle(row);
                    btn.style.display = 'none';
                    delBtn.style.display = '';
                };
                delBtn.onclick = () => {
                    let arr = getHighlighted();
                    arr = arr.filter(id => id !== jobId);
                    setHighlighted(arr);
                    removeHighlightStyle(row);
                    btn.style.display = '';
                    delBtn.style.display = 'none';
                };
            });
        }
        setupHighlightButtons();
        const observer = new MutationObserver(setupHighlightButtons);
        observer.observe(document.body, {childList: true, subtree: true});
    }
})();
